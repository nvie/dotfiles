#!/bin/sh
set -eu

base="$(basename "$(pwd)")"

if [ "$base" != "liveblocks-client" -a "$base" != "liveblocks-react" ]; then
    echo "Please run this script from the liveblocks-client or liveblocks-react directory"
    exit 1
fi

# Changes rollup to produce a build without internal APIs. This way, we will
# not generate a shared.d.ts, making the final diff easier to compare.
hack_the_build () {
    if [ -f rollup.config.js ]; then
        sr -s 'srcFiles = \["index.ts", "internal.ts"\]' \
           -r 'srcFiles = ["index.ts"]'                  \
           rollup.config.js
    else
        sr -s '\["src/index.ts", "src/internal.ts"\]' \
           -r '["src/index.ts"]'                      \
           tsup.config.js
    fi
}

build_output () {
    npm i
    rm -rf lib dist
    hack_the_build
    npm run build

    if [ -d dist ]; then
        prettier --write dist/index.d.ts
    else
        prettier --write lib/index.d.ts
    fi
}

# -----------------------------------------------------------------------------
# Now first generate the index.d.ts file for the _current_ public API (the base
# for the comparison)
if [ $# -ne 1 ]; then
    echo "usage: api-diff <tag>"
    exit 1
fi

if [ ! -f "/tmp/$base-$1.d.ts" ]; then
    git is-clean -v
    git checkout "$1"
    build_output

    # Store the results in /tmp
    cp dist/index.d.ts "/tmp/$base-$1.d.ts"

    git drop-local-changes

    # Switch back
    git checkout -
fi

# -----------------------------------------------------------------------------
# Next, generate the public index.d.ts for the current branch

git is-clean -v
build_output

# Store the results in /tmp
if [ -d dist ]; then
    cp dist/index.d.ts "/tmp/$base-new.d.ts"
else
    cp lib/index.d.ts "/tmp/$base-new.d.ts"
fi

git drop-local-changes
rm -rf lib dist

# Show the diff
colordiff -u "/tmp/$base-$1.d.ts" "/tmp/$base-new.d.ts" | less -R
echo "colordiff -u \"/tmp/$base-$1.d.ts\" \"/tmp/$base-new.d.ts\" | less -R"
